# ==============================================================================
# .htaccess Configuration for Zeop Website CMS Project
# ==============================================================================

# Enable URL Rewriting
RewriteEngine On

# ==============================================================================
# SECURITY HEADERS
# ==============================================================================

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|json)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Protect against clickjacking
Header always append X-Frame-Options SAMEORIGIN

# XSS Protection
Header set X-XSS-Protection "1; mode=block"

# Content Type Options
Header set X-Content-Type-Options nosniff

# Referrer Policy
Header set Referrer-Policy "strict-origin-when-cross-origin"

# Content Security Policy (adjust as needed)
Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:;"

# ==============================================================================
# CORS HEADERS FOR API
# ==============================================================================

# Enable CORS for API endpoints and ensure proper JSON content-type
<IfModule mod_headers.c>
    # Set JSON content-type for API responses
    <LocationMatch "^/api/">
        Header always set Content-Type "application/json; charset=utf-8"
    </LocationMatch>
    
    SetEnvIf Origin "^(https?://(localhost|127\.0\.0\.1)(:[0-9]+)?|https?://[^/]*\.?(zeotourism\.com|zeopwebsite\.com))$" CORS_ALLOW_ORIGIN=$1
    Header always set Access-Control-Allow-Origin %{CORS_ALLOW_ORIGIN}e env=CORS_ALLOW_ORIGIN
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
</IfModule>

# Handle preflight OPTIONS requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# ==============================================================================
# PERFORMANCE OPTIMIZATIONS
# ==============================================================================

# Enable Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# ==============================================================================
# API ROUTING (Handle first to avoid conflicts)
# ==============================================================================

# Route API requests to Node.js server running on port 3000
RewriteCond %{REQUEST_URI} ^/api/(.*)$
RewriteRule ^api/(.*)$ http://localhost:3000/api/$1 [P,L]

# Alternative: If mod_proxy is not available, use CGI wrapper
# RewriteCond %{REQUEST_URI} ^/api/(.*)$
# RewriteRule ^api/(.*)$ /cgi-bin/node-wrapper.cgi [L]

# ==============================================================================
# URL REWRITING FOR SPA (Single Page Application)
# ==============================================================================

# Handle React Router (for frontend) - but skip API routes and static files
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteCond %{REQUEST_URI} !^/uploads/
RewriteCond %{REQUEST_URI} !^/assets/
RewriteRule ^(.*)$ /index.html [QSA,L]

# ==============================================================================
# TOUR DETAIL PAGES SEO-FRIENDLY URLS
# ==============================================================================

# Redirect old tour URLs to new SEO-friendly format
RewriteRule ^tour/([0-9]+)/?$ /tours/$1 [R=301,L]

# Handle tour detail pages
RewriteRule ^tours/([a-zA-Z0-9\-]+)/?$ /tour-details/$1 [QSA,L]

# Handle destination pages
RewriteRule ^destinations/([a-zA-Z0-9\-]+)/?$ /destination/$1 [QSA,L]

# Handle activity pages
RewriteRule ^activities/([a-zA-Z0-9\-]+)/?$ /activity/$1 [QSA,L]

# ==============================================================================
# REDIRECT RULES
# ==============================================================================

# Force HTTPS (uncomment when SSL is configured)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Remove trailing slashes (except for directories)
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{THE_REQUEST} /+[^\s]*\s [NC]
RewriteRule ^(.*)/$1 [R=301,L]

# Redirect www to non-www (or vice versa - choose one)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# ==============================================================================
# ERROR PAGES
# ==============================================================================

ErrorDocument 404 /404.html
ErrorDocument 500 /500.html
ErrorDocument 403 /403.html

# ==============================================================================
# MIME TYPES
# ==============================================================================

# Ensure proper MIME types
AddType application/javascript .js
AddType text/css .css
AddType application/json .json
AddType image/webp .webp
AddType image/svg+xml .svg

# ==============================================================================
# DIRECTORY BROWSING
# ==============================================================================

# Disable directory browsing
Options -Indexes

# ==============================================================================
# FILE UPLOAD LIMITS
# ==============================================================================

# Increase upload limits for tour images
php_value upload_max_filesize 10M
php_value post_max_size 10M
php_value max_execution_time 300
php_value max_input_time 300

# ==============================================================================
# CUSTOM RULES FOR TOUR DATA
# ==============================================================================

# Protect tour data files from direct access
<Files "tours.json">
    Order Allow,Deny
    Allow from all
</Files>

<Files "destinations.json">
    Order Allow,Deny
    Allow from all
</Files>

# Allow access to tour detail JSON files for API
<FilesMatch "^[a-zA-Z0-9\-]+\.json$">
    <IfModule mod_headers.c>
        Header set Content-Type "application/json"
        Header set Cache-Control "public, max-age=3600"
    </IfModule>
</FilesMatch>

# ==============================================================================
# MAINTENANCE MODE (uncomment to enable)
# ==============================================================================

# RewriteCond %{REQUEST_URI} !/maintenance.html$
# RewriteCond %{REMOTE_ADDR} !^123\.456\.789\.000$
# RewriteRule $ /maintenance.html [R=302,L]

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================